---
title: "Saldana, Montano, et al. -- 10 Velocyto analysis"
author: "Christoph Hafemeister"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    highlight: pygments
    df_print: paged
---

# Velocyto Analysis

## Dependencies

This script depends on some functions and objects on R/setup_bob.R and the script R/scutils.R It also depends on the outputs generated by scrna/03

## Outputs

* Velocyto figure of Supplementary figure 3c

# Setup
```{r}
source("R/setup.R")
library('dplyr')
```

Install missing packages
```{r}
BiocManager::install("pcaMethods", update = FALSE)
devtools::install_github("velocyto-team/velocyto.R", ref = '83e6ed9')
```

Set max threads for BLAS
```{r}
BiocManager::install("RhpcBLASctl", update = FALSE)
RhpcBLASctl::blas_set_num_threads(config$OPENBLAS_NUM_THREADS)
```

## Main

### Define colors

```{r}
COLOR_PALETTES$type <- c(SCP = "#fb8072", mesenchyme = "#8dd3c7", sympathoblasts = "#fdb462", 
other = "#d9d9d9")
COLOR_PALETTES$type3 <- c(SCP = "#fb8072", mesenchyme = "#8dd3c7", sympathoblasts = "#fdb462", 
chromaffin = "#C045FF", other = "#d9d9d9")
```


### Load meta data
```{r}
md_path <- file.path(config$out_root, 'input_data', 'WT_dataset_metadata_with_UMAP_coordinates.rds')
md <- readRDS(md_path)


# add the library name
lib_md <- readr::read_csv(file = file.path(config$project_root, 'metadata', 'velocyto_libraries.csv'))
md <- left_join(md, lib_md, by = c('orig.ident' = 'orig_ident'))

table(md$orig.ident, md$stage)
table(md$orig.ident, md$type)
table(md$orig.ident, md$type3)
```

Set UMAP dimensions
```{r}
md$UMAP_1 <- md$wtumapfullscvi822_1
md$UMAP_2 <- md$wtumapfullscvi822_2
```

Show stage and WT.clusters

```{r}
library('ggplot2')
ggplot(md, aes(UMAP_1, UMAP_2, color = stage)) + 
  geom_point()
ggplot(md, aes(UMAP_1, UMAP_2, color = WT.clusters)) + 
  geom_point()
```

Show clusters

```{r}
ggplot(md, aes(UMAP_1, UMAP_2, color = seurat_clusters)) + 
  geom_point()
ggplot(md, aes(UMAP_1, UMAP_2, color = seurat_clusters_premerge)) + 
  geom_point()
```

Same as before, but color by type and type3

```{r}
ggplot(md, aes(UMAP_1, UMAP_2, color = type)) + 
  scale_color_manual(values = COLOR_PALETTES$type) +
  geom_point()

ggplot(md, aes(UMAP_1, UMAP_2, color = type3)) + 
  scale_color_manual(values = COLOR_PALETTES$type3) +
  geom_point()
```

Choose which cells to use downstream: Just use all
```{r}
sel_md <- md
```

### Load the velocyto loom files

Create spliced and unspliced matrices for all libraries; keep only previously selected cells.

```{r}
library('velocyto.R')

loom_files <- list.files(path = file.path(config$out_root, 'scrna', 'velocyto'), pattern = '\\.loom$', full.names = TRUE)

e_list <- list()
n_list <- list()
cellname_df_list <- list()
for (lf in loom_files) {
  ldat <- read.loom.matrices(file = lf)
  # extract library name and use it to modify cell name to align with meta data dsbarcode column
  cellname_df <- stringr::str_split_fixed(string = colnames(ldat$spliced), pattern = ':', n = Inf) %>%
    as.data.frame() %>%
    dplyr::rename('library_name' = 'V1', 'barcode' = 'V2') %>%
    mutate(barcode = stringr::str_remove(string = barcode, pattern = 'x$')) %>%
    left_join(lib_md, by = 'library_name') %>%
    mutate(dsbarcode = paste(orig_ident, barcode, sep = '_'))
    
  sel <- cellname_df$dsbarcode %in% sel_md$dsbarcode
  lib_name <- stringr::str_remove(basename(lf), pattern = '\\.loom$')
  e_list[[lib_name]] <- ldat$spliced[, sel, drop = FALSE]
  n_list[[lib_name]] <- ldat$unspliced[, sel, drop = FALSE]
  colnames(e_list[[lib_name]]) <- cellname_df$dsbarcode[sel]
  colnames(n_list[[lib_name]]) <- cellname_df$dsbarcode[sel]
  cellname_df_list[[lib_name]] <- cellname_df[sel, , drop = FALSE]
}
emat <- do.call(cbind, e_list)
nmat <- do.call(cbind, n_list)

cellname_df <- bind_rows(cellname_df_list)

velo_md <- left_join(select(cellname_df, dsbarcode), sel_md, by = 'dsbarcode')
rownames(velo_md) <- velo_md$dsbarcode
```

Save to file
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'spliced_unspliced.rds')
saveRDS(object = list(spliced = emat, unspliced = nmat, md = velo_md), file = outf)
```

### Do the velocity estimation

Follow the vignette here: [http://pklab.med.harvard.edu/velocyto/notebooks/R/DG1.nb.html](http://pklab.med.harvard.edu/velocyto/notebooks/R/DG1.nb.html)

Besides the spliced/unspliced counts, we can use a cell to cell distance matrix. Here we use euclidean distance in UMAP space. We could also use correlation in PCA space, but don't have that available at the moment. Update: ignore for now.
```{r}
#cell_dist <- dist(sel_md[, c('UMAP_1', 'UMAP_2')]) 
```

```{r}
clusters <- velo_md$seurat_clusters
names(clusters) <- rownames(velo_md)
emat <- filter.genes.by.cluster.expression(emat = emat, clusters = clusters,
                                           min.max.cluster.average = 0.5)
nmat <- filter.genes.by.cluster.expression(emat = nmat, clusters = clusters, 
                                           min.max.cluster.average = 0.05)
length(intersect(rownames(emat),rownames(emat)))

outf <- file.path(config$out_root, 'scrna', 'velocyto', 'spliced_unspliced_filtered.rds')
saveRDS(object = list(spliced = emat, unspliced = nmat, md = velo_md), file = outf)
```

```{r}
fit_quantile <- 0.02
rvel_cd <- gene.relative.velocity.estimates(emat = emat,
                                            nmat = nmat,
                                            deltaT = 1,
                                            kCells = 20,
                                            cell.dist = NULL,
                                            fit.quantile = fit_quantile,
                                            n.cores = config$VELOCYTO_N_CORES)
```

Save to file
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_estimates.rds')
saveRDS(object = rvel_cd, file = outf)
```

Viz
```{r}

ccol <- COLOR_PALETTES$type[velo_md$type]
names(ccol) <- rownames(velo_md)

p <- show.velocity.on.embedding.cor(
  emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
  vel = rvel_cd,
  n = 300,
  scale = 'sqrt',
  cell.colors = ac(ccol, alpha = 0.5),
  cex = 0.8,
  arrow.scale = 5,
  show.grid.flow = TRUE,
  min.grid.cell.mass = 0.5,
  grid.n = 40,
  arrow.lwd = 1,
  do.par = FALSE,
  cell.border.alpha = 0.1,
  return.details = FALSE, 
  n.cores = config$VELOCYTO_N_CORES)
```

Save figure details
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_on_embedding_details.rds')
saveRDS(object = p, file = outf)
```

Save figure as pdf
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_on_embedding.pdf')
pdf(file = outf, width = 6, height = 6)
show.velocity.on.embedding.cor(
  emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
  vel = rvel_cd,
  cc = p$cc,
  n = 300,
  scale = 'sqrt',
  cell.colors = ac(ccol, alpha = 0.5),
  cex = 0.8,
  arrow.scale = 5,
  show.grid.flow = TRUE,
  min.grid.cell.mass = 0.5,
  grid.n = 40,
  arrow.lwd = 1,
  do.par = FALSE,
  cell.border.alpha = 0, 
  return.details = FALSE,
  n.cores = config$VELOCYTO_N_CORES)
dev.off()
```

Color by type3
```{r}
ccol <- COLOR_PALETTES$type3[velo_md$type3]
names(ccol) <- rownames(velo_md)

outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_on_embedding_type3.pdf')
pdf(file = outf, width = 6, height = 6)
show.velocity.on.embedding.cor(
  emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
  vel = rvel_cd,
  cc = p$cc,
  n = 300,
  scale = 'sqrt',
  cell.colors = ac(ccol, alpha = 0.5),
  cex = 0.8,
  arrow.scale = 5,
  show.grid.flow = TRUE,
  min.grid.cell.mass = 0.5,
  grid.n = 40,
  arrow.lwd = 1,
  do.par = FALSE,
  cell.border.alpha = 0, 
  return.details = FALSE)
dev.off()
```
### Velocity with given cellKNN

Create knn matrix based on UMAP 
```{r}
kCells <- 20  # 20 was what we used before
emb_mat <- as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')])
# cellKNN should be cell by cell dgCMatrix with colsums kCells + 1 

BiocManager::install("BiocNeighbors", update = FALSE)
library('BiocNeighbors')
fout <- findKNN(emb_mat, k = kCells, BNPARAM = KmknnParam())
knn_index <- cbind(1:nrow(emb_mat), fout$index)

library('Matrix')
i <- as.integer(apply(knn_index, 1, sort) - 1)
p <- as.integer(c(0, cumsum(rep(ncol(knn_index), nrow(knn_index)))))
x <- rep(1, length(knn_index))
cellKNN <- new("dgCMatrix", i = i, p = p, x = x, Dim = c(nrow(knn_index), nrow(knn_index)),
               Dimnames = list(rownames(velo_md), rownames(velo_md)))
```

```{r}
rvel_cd2 <- gene.relative.velocity.estimates(emat = emat,
                                            nmat = nmat,
                                            deltaT = 1,
                                            cellKNN = cellKNN,  
                                            cell.dist = NULL,
                                            fit.quantile = fit_quantile,
                                            n.cores = config$VELOCYTO_N_CORES)
```

Save to file
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_estimates2.rds')
saveRDS(object = rvel_cd2, file = outf)
```

Viz
```{r}
ccol <- COLOR_PALETTES$type3[velo_md$type3]
names(ccol) <- rownames(velo_md)

p2 <- show.velocity.on.embedding.cor(
  emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
  vel = rvel_cd2,
  n = 300,
  scale = 'sqrt',
  cell.colors = ac(ccol, alpha = 0.5),
  cex = 0.8,
  arrow.scale = 5,
  show.grid.flow = TRUE,
  min.grid.cell.mass = 0.5,
  grid.n = 40,
  arrow.lwd = 1,
  do.par = FALSE,
  cell.border.alpha = 0.1,
  return.details = FALSE, 
  n.cores = config$VELOCYTO_N_CORES)
```

Save figure details
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_on_embedding_details2.rds')
saveRDS(object = p2, file = outf)
```

Save figure as pdf
```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocity_on_embedding2.pdf')
pdf(file = outf, width = 12, height = 12)
show.velocity.on.embedding.cor(
  emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
  vel = rvel_cd2,
  cc = p2$cc,
  n = 300,
  scale = 'sqrt',
  cell.colors = ac(ccol, alpha = 0.5),
  cex = 0.8,
  arrow.scale = 5,
  show.grid.flow = TRUE,
  min.grid.cell.mass = 0.5,
  grid.n = 40,
  arrow.lwd = 1,
  do.par = FALSE,
  cell.border.alpha = 0, 
  return.details = FALSE,
  n.cores = config$VELOCYTO_N_CORES)
dev.off()
```
## Save objects

```{r}
outf <- file.path(config$out_root, 'scrna', 'velocyto', 'velocyto_objects.rds')
saveRDS(object = list(emb = as.matrix(velo_md[, c('UMAP_1', 'UMAP_2')]),
                      vel = rvel_cd2,
                      cc = p2$cc,
                      cell.colors = ac(ccol, alpha = 0.5),
                      ccol = ccol), 
        file = outf)
```


## Session info etc.

Runtime: `r time_diff(SETUP_TIME)`

```{r}
sessionInfo()
```
